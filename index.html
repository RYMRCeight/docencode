<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Registry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better readability and aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">Document Registry Tracker</h1>
        <p id="auth-status" class="text-center mb-4 text-xs text-gray-500">Initializing...</p>

        <section id="login-view-container" class="container-card bg-white p-8 rounded-xl max-w-sm mx-auto mb-8">
            <h2 class="text-2xl font-semibold text-indigo-700 mb-6 text-center">Admin Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="login-email" required placeholder="admin@example.com"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password" required placeholder="••••••••"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <button type="submit" id="login-button"
                        class="w-full bg-indigo-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Sign In
                </button>
            </form>
        </section>


        <section id="app-view-container">
            
            <div class="mb-6 flex justify-between items-center">
                <button id="view-toggle-button" class="hidden bg-indigo-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Record New Document
                </button>
                <button id="logout-button" class="hidden bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition duration-150 ease-in-out">
                    Logout
                </button>
            </div>


            <section id="form-view-container" class="hidden container-card bg-white p-6 md:p-8 rounded-xl mb-10">
                <h2 id="form-title" class="text-2xl font-semibold text-indigo-700 mb-6">Add New Document</h2>
                <form id="document-form" class="space-y-4">
                    <input type="hidden" id="docId" value="">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="docNumber" class="block text-sm font-medium text-gray-700">Document Number</label>
                            <input type="text" id="docNumber" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="docDate" class="block text-sm font-medium text-gray-700">Date Issued</label>
                            <input type="date" id="docDate" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                    </div>

                    <div>
                        <label for="docTitle" class="block text-sm font-medium text-gray-700">Title / Subject</label>
                        <input type="text" id="docTitle" required
                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="docType" class="block text-sm font-medium text-gray-700">Document Type</label>
                        <select id="docType" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="" disabled selected>Select a document type</option>
                        </select>
                    </div>

                 <div class="flex gap-4">
  <button
    type="submit"
    id="submit-button"
    class="flex-1 bg-indigo-600 text-white py-3 rounded-lg"
  >
    Record Document
  </button>

  <button
    type="button"
    id="cancel-edit-button"
    class="hidden bg-gray-400 text-white py-3 px-4 rounded-lg"
  >
    Cancel
  </button>
</div>
</form>
</section>


            <section id="list-view-container">
                
                <div class="container-card bg-white p-6 md:p-8 rounded-xl mb-6">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Document Dashboard</h2>
                    
                    <form id="search-form" class="flex gap-4 mb-6">
                        <div class="flex-grow">
                            <label for="search-input" class="sr-only">Search Documents</label>
                            <input type="text" id="search-input" placeholder="Search by Document # or Title..."
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        
                        <button type="button" id="refresh-button"
                                class="bg-gray-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-gray-600 transition duration-150 ease-in-out shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-rotate-cw">
                                <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-7.3 3.3L3 9"/>
                                <path d="M3 3v6h6"/>
                                <path d="M3 12a9 9 0 0 0 17.7 2.9L21 15"/>
                                <path d="M21 21v-6h-6"/>
                            </svg>
                        </button>
                        
                        <button type="submit" id="search-button"
                                class="bg-indigo-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-indigo-700 transition duration-150 ease-in-out shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            Search
                        </button>
                    </form>

                    <div id="document-categories-container" class="space-y-8">
                        <p id="loading-message" class="text-center text-indigo-500 font-medium p-8">Loading documents...</p>
                        </div>

                </div>
            </section>
            
            <section id="type-management-container" class="hidden container-card bg-white p-6 md:p-8 rounded-xl mb-10 mt-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-2">Manage Document Types</h2>
                
                <form id="new-type-form" class="flex flex-col md:flex-row gap-4 items-end mb-8">
                    <div class="flex-grow w-full">
                        <label for="new-type-name" class="block text-sm font-medium text-gray-700">Add New Type Name</label>
                        <input type="text" id="new-type-name" required placeholder="e.g., Policy Directive"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" id="add-type-button"
                            class="w-full md:w-auto bg-green-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-700 transition duration-150 ease-in-out shadow-lg transform hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        Add Type
                    </button>
                </form>

                <div id="type-list-display">
                    <h3 class="text-lg font-medium text-gray-700 mb-3">Currently Available Types:</h3>
                    <div id="type-tags" class="flex flex-wrap gap-2">
                        </div>
                    <p id="type-loading-message" class="text-sm text-gray-500 mt-4 hidden">Loading types...</p>
                </div>
            </section>


        </section> <div id="notification-box" class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-xl hidden" role="alert">
            Message will appear here.
        </div>

        <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:max-w-md transform transition-all duration-300 scale-100">
                <h3 class="text-xl font-bold text-gray-800 mb-4" id="modal-title">Confirm Deletion</h3>
                <p class="text-gray-600 mb-6" id="modal-message">Are you sure you want to proceed with this action?</p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                        Cancel
                    </button>
                    <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition">
                        Confirm Delete
                    </button>
                </div>
            </div>
        </div>

        <div id="link-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden flex items-center justify-center transition-opacity duration-300">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 md:max-w-md transform transition-all duration-300 scale-100">
                <h3 class="text-xl font-bold text-gray-800 mb-4" id="link-modal-title">Link File to Document</h3>
                <p class="text-gray-600 mb-4">Enter the external URL for Document #<span id="link-doc-number" class="font-bold"></span>.</p>
                <form id="link-file-form" class="space-y-4">
                    <input type="hidden" id="link-doc-id" value="">
                    <div>
                        <label for="file-link-input" class="block text-sm font-medium text-gray-700">File URL (PDF, Doc, etc.)</label>
                        <input type="url" id="file-link-input" required placeholder="https://example.com/document.pdf"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="link-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                            Cancel
                        </button>
                        <button type="submit" id="link-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition">
                            Save Link
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // =========================================================================
        // !!! SUPABASE CREDENTIALS SET FROM USER INPUT !!!
        // =========================================================================
        const SUPABASE_URL = 'https://iizhoebadchhxyhgwuqi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlpemhvZWJhZGNoaHh5aGd3dXFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMjUzMjMsImV4cCI6MjA3NDYwMTMyM30.jfKnkSL-tT7gYqp44KsJfKQy5wXjxsFOmqbVLTNC2jQ';
        const TABLE_NAME = 'document_records';
        // =========================================================================

        let supabase;
        let user = null; 
        
        // Global State/Constants
        const TYPES_TABLE_NAME = 'document_types';
        let documentTypes = []; // [{name: 'Executive Order', id: 1}, ...]

        // UI Elements
        const form = document.getElementById('document-form');
        const docIdInput = document.getElementById('docId');
        const formTitle = document.getElementById('form-title');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const docNumberInput = document.getElementById('docNumber');
        const docTitleInput = document.getElementById('docTitle');
        const docDateInput = document.getElementById('docDate');
        const docTypeSelect = document.getElementById('docType');

        const loadingMessage = document.getElementById('loading-message');
        const authStatus = document.getElementById('auth-status');
        const submitButton = document.getElementById('submit-button');
        const notificationBox = document.getElementById('notification-box');

        // Login UI Elements
        const loginViewContainer = document.getElementById('login-view-container');
        const logoutButton = document.getElementById('logout-button');
        const loginForm = document.getElementById('login-form');

        // View and Filter Control Elements
        const formViewContainer = document.getElementById('form-view-container');
        const listViewContainer = document.getElementById('list-view-container'); // ADDED: Need to reference the list container
        const viewToggleButton = document.getElementById('view-toggle-button');
        
        // Search Elements
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const refreshButton = document.getElementById('refresh-button');
        
        const documentCategoriesContainer = document.getElementById('document-categories-container');
        
        // Type Management Elements
        const newTypeForm = document.getElementById('new-type-form');
        const newTypeNameInput = document.getElementById('new-type-name');
        const addTypeButton = document.getElementById('add-type-button');
        const typeTagsContainer = document.getElementById('type-tags');
        const typeLoadingMessage = document.getElementById('type-loading-message');
        const typeManagementContainer = document.getElementById('type-management-container'); 

        // Modal Elements
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        const linkModal = document.getElementById('link-modal');
        const linkFileForm = document.getElementById('link-file-form');
        const linkDocIdInput = document.getElementById('link-doc-id');
        const linkDocNumberSpan = document.getElementById('link-doc-number');
        const fileLinkInput = document.getElementById('file-link-input');
        const linkCancelBtn = document.getElementById('link-cancel-btn');


        /**
         * Clears the form, resets the hidden ID, and sets the UI back to 'Add New Document' mode.
         */
        function resetDocumentForm() {
            docIdInput.value = '';
            form.reset();
            formTitle.textContent = 'Add New Document';
            submitButton.textContent = 'Record Document';
            cancelEditButton.classList.add('hidden');
        }

        /**
         * Toggles the visibility between the document form and the dashboard list.
         * Resets the form if switching to list view.
         * @param {boolean} showForm - True to show form, false to show list.
         */
        function toggleFormVisibility(showForm = formViewContainer.classList.contains('hidden')) {
            if (!user) return; // Only admin can toggle form

            if (showForm) {
                resetDocumentForm(); 
                formViewContainer.classList.remove('hidden');
                listViewContainer.classList.add('hidden'); // ADDED: Hide list view
                typeManagementContainer.classList.add('hidden');
                viewToggleButton.textContent = '← Back to Document Dashboard';
            } else {
                formViewContainer.classList.add('hidden');
                listViewContainer.classList.remove('hidden'); // ADDED: Show list view
                typeManagementContainer.classList.remove('hidden');
                viewToggleButton.textContent = 'Record New Document';
                fetchAndRenderDocuments(); // Refresh when returning to the dashboard
            }
        }
        
        /**
         * Converts document type to a corresponding Tailwind color class.
         * @param {string} type - The document type string.
         * @returns {string} Tailwind class string.
         */
        function getTypeColor(type) {
            if (type.includes('Executive')) return 'bg-red-100 text-red-800 ring-red-500';
            if (type.includes('Memorandum')) return 'bg-blue-100 text-blue-800 ring-blue-500';
            if (type.includes('Urgent')) return 'bg-yellow-100 text-yellow-800 ring-yellow-500';
            return 'bg-gray-100 text-gray-800 ring-gray-500';
        }

        /**
 * A natural sort function for strings that contain numbers.
 * This is crucial for sorting document numbers like '1', '10', '2' correctly.
 * @param {string} a - First string.
 * @param {string} b - Second string.
 * @returns {number} Standard sort comparison result (-1, 0, 1).
 */
function naturalSort(a, b) {
    if (a === b) return 0;
    if (!a) return 1; // Put null/undefined/empty at the end
    if (!b) return -1;

    // Regex to split string into numeric and non-numeric parts
    const re = /(^([+-]?\d*(\.\d*)?)([eE][+-]?\d+)?$|^0x[\da-fA-F]+$|\d+)/g;
    const tokensA = a.toString().match(re) || [a.toString()];
    const tokensB = b.toString().match(re) || [b.toString()];

    for (let i = 0; i < Math.min(tokensA.length, tokensB.length); i++) {
        const tokenA = tokensA[i];
        const tokenB = tokensB[i];

        const floatA = parseFloat(tokenA);
        const floatB = parseFloat(tokenB);

        // If both tokens are numbers, compare them numerically
        if (!isNaN(floatA) && !isNaN(floatB) && floatA === floatB) {
            // Numbers are equal, continue to next token for tie-breaking
            continue;
        } else if (!isNaN(floatA) && !isNaN(floatB)) {
            // One number is larger
            return floatA - floatB;
        }

        // If not numbers, compare them as strings
        if (tokenA < tokenB) return -1;
        if (tokenA > tokenB) return 1;
    }

    // Fallback for strings of different lengths (e.g., 'a1' vs 'a1b')
    return tokensA.length - tokensB.length;
}
        
        /**
         * Shows a temporary notification message.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         */
        function showNotification(message, type = 'success') {
            notificationBox.textContent = message;
            if (type === 'success') {
                notificationBox.classList.remove('bg-red-500');
                notificationBox.classList.add('bg-green-500');
            } else if (type === 'error') {
                notificationBox.classList.remove('bg-green-500');
                notificationBox.classList.add('bg-red-500');
            }
            
            notificationBox.classList.remove('hidden');
            
            setTimeout(() => {
                notificationBox.classList.add('hidden');
            }, 3000);
        }
        
        /**
         * Displays a custom confirmation modal instead of window.confirm().
         * @param {string} title - The title of the modal.
         * @param {string} message - The message body.
         * @param {string} confirmText - Text for the confirm button.
         * @returns {Promise<boolean>} Resolves true if confirmed, false if canceled.
         */
        function showConfirmationModal(title, message, confirmText = 'Confirm') {
            return new Promise(resolve => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalConfirmBtn.textContent = confirmText;
                
                confirmationModal.classList.remove('hidden');

                modalConfirmBtn.onclick = null;
                modalCancelBtn.onclick = null;

                modalConfirmBtn.onclick = () => {
                    confirmationModal.classList.add('hidden');
                    resolve(true);
                };
                modalCancelBtn.onclick = () => {
                    confirmationModal.classList.add('hidden');
                    resolve(false);
                };
            });
        }

        /**
 * Fetches document types from the database, updates global state, and refreshes UI.
 * This function must be the bridge between auth state and document loading.
 */
async function fetchAndRenderDocumentTypes() {
    // Show a small loading indicator for the type list
    typeLoadingMessage.classList.remove('hidden'); 

    const { data: types, error } = await supabase
        .from(TYPES_TABLE_NAME)
        // Ensure 'is_public' is fetched for the public view filter
        .select('id, name, is_public') 
        .order('name', { ascending: true }); // Order alphabetically

    typeLoadingMessage.classList.add('hidden');

    if (error) {
        console.error("Error fetching document types:", error);
        showNotification(`Error loading document types: ${error.message}`, 'error');
        documentTypes = []; // Clear types on error
    } else {
        documentTypes = types || [];
    }

    // 1. Update the document creation form dropdown
    renderFormSelects(); 
    
    // 2. Update the admin management list with public toggles
    renderTypeList();
    
    // 3. CRUCIAL: Trigger the final document fetch
    fetchAndRenderDocuments(); 
}
        /**
         * Handles the login attempt using Supabase Auth.
         */
        async function handleLogin(event) {
            event.preventDefault();
            if (!supabase) return showNotification('Database not initialized.', 'error');

            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();

            const loginButton = document.getElementById('login-button');
            loginButton.textContent = 'Logging in...';
            loginButton.disabled = true;

            const { error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                console.error("Login error:", error);
                showNotification(`Login failed: ${error.message}`, 'error');
                loginButton.textContent = 'Sign In';
                loginButton.disabled = false;
            } else {
                loginForm.reset();
                loginButton.textContent = 'Sign In';
                loginButton.disabled = false;
                // Success is handled by the onAuthStateChange listener
            }
        }

        /**
         * Handles the logout request.
         */
        async function handleLogout() {
            if (!supabase) return;
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Logout error:", error);
                showNotification('Logout failed.', 'error');
            } else {
                showNotification('Logged out successfully. You are now in read-only mode.', 'success');
            }
        }

        /**
         * Updates the UI state based on the current authentication session.
         * Note: The main dashboard is always visible, but admin features are hidden/shown here.
         * @param {Object} session - The current Supabase session object.
         */
        function updateUIForAuth(session) {
            user = session ? session.user : null;

            if (user) {
                // ADMIN (Logged In) VIEW
                loginViewContainer.classList.add('hidden'); 
                logoutButton.classList.remove('hidden');
                viewToggleButton.classList.remove('hidden');
                typeManagementContainer.classList.remove('hidden');
                authStatus.textContent = `User: ${user.email} | DB Status: Connected (Admin)`;
                
                // Switch to list view when logging in
                if (formViewContainer.classList.contains('hidden')) {
                     toggleFormVisibility(false); 
                }

            } else {
                // PUBLIC (Read-Only) VIEW
                loginViewContainer.classList.remove('hidden'); 
                logoutButton.classList.add('hidden');
                viewToggleButton.classList.add('hidden');
                formViewContainer.classList.add('hidden'); 
                typeManagementContainer.classList.add('hidden');
                authStatus.textContent = 'DB Status: Connected (Read-Only Mode)';
            }
            
            // Regardless of login status, fetch types and documents 
            // The type fetch is non-blocking and always calls document fetch next.
            fetchAndRenderDocumentTypes(); 
        }

        /**
         * Sets up the real-time listener for a given table.
         */
        function setupRealtimeListener(tableName, callback) {
             supabase
                .channel(`${tableName}_changes`) 
                .on(
                    'postgres_changes', 
                    { event: '*', schema: 'public', table: tableName },
                    (payload) => {
                        console.log(`Realtime change received for ${tableName}:`, payload.eventType);
                        // Only auto-update if the document list is currently visible to prevent race conditions when editing
                        if (user || formViewContainer.classList.contains('hidden')) {
                             callback();
                        }
                    }
                )
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log(`Supabase Realtime subscribed to ${tableName} changes.`);
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error(`Supabase Realtime channel error for ${tableName}.`);
                    }
                });
        }
        
        /**
         * Initializes Supabase client and sets up auth and realtime listeners.
         */
        async function initializeSupabase() {
            authStatus.textContent = 'Initializing connection...';

            if (SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                const errorMsg = "ERROR: Supabase credentials are not set.";
                console.error(errorMsg);
                authStatus.textContent = errorMsg;
                submitButton.disabled = true;
                return;
            }

            try {
                // Use the anonymous key for read access
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized.");
                
                // Set up Auth State Listener
                supabase.auth.onAuthStateChange((event, session) => {
                    updateUIForAuth(session);
                });

                // Get initial session state for the first render
                const { data: { session } } = await supabase.auth.getSession();
                updateUIForAuth(session);

                // Setup Realtime Listeners
                setupRealtimeListener(TABLE_NAME, fetchAndRenderDocuments);
                setupRealtimeListener(TYPES_TABLE_NAME, fetchAndRenderDocumentTypes);

            } catch (error) {
                console.error("Error during Supabase initialization:", error);
                authStatus.textContent = `Error: ${error.message}`;
            }
        }
        
        // --- TYPE MANAGEMENT FUNCTIONS (CRUD) ---
/* duplicate fetchAndRenderDocumentTypes removed */
        /**
         * Renders the available document types into the form select (Admin only).
         */
        function renderFormSelects() {
            // 1. Update Document Form Select (#docType)
            const formOptions = documentTypes.map(type => 
                `<option value="${type.name}">${type.name}</option>`
            ).join('');
            
            docTypeSelect.innerHTML = 
                `<option value="" disabled selected>Select a document type</option>` + formOptions;
        }

        /**
         * Renders the current list of available types as tags with delete buttons (Admin only).
         */
       function renderTypeList() {
    typeTagsContainer.innerHTML = '';
    
    // Add a label/key for the Public Status column
    const header = document.createElement('div');
    header.className = 'grid grid-cols-3 gap-2 text-sm font-semibold text-gray-600 border-b pb-2 mb-3';
header.innerHTML = `
    <span>Type Name</span>
    <span class="text-center">Public View</span>
    <span class="text-center">Action</span>
`;
    typeTagsContainer.appendChild(header);

    if (documentTypes.length === 0) {
        typeTagsContainer.innerHTML += `<p class="text-gray-500 text-center col-span-full">No types defined yet.</p>`;
        return;
    }

    documentTypes.forEach(type => {
        const item = document.createElement('div');
        item.className = 'grid grid-cols-3 gap-2 items-center bg-gray-50 p-2 rounded-lg border-b';
item.innerHTML += `<span class="text-gray-800 font-medium truncate">${type.name}</span>`;
if (user) {
    item.innerHTML += `
        <div class="flex justify-center">
            <input type="checkbox" id="public-toggle-${type.id}" data-type-id="${type.id}" ${type.is_public ? 'checked' : ''} class="public-toggle-btn h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
        </div>
        <div class="flex justify-center">
            <button data-type-id="${type.id}" data-type-name="${type.name}" class="delete-type-btn p-1 text-red-500 hover:text-red-700 rounded-full transition duration-150 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash">
                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                </svg>
            </button>
        </div>
    `;
} else {
    item.innerHTML += `
        <span class="text-center text-sm font-semibold text-${type.is_public ? 'green-600' : 'red-600'}">${type.is_public ? 'YES' : 'NO'}</span>
        <span></span>
    `;
}
typeTagsContainer.appendChild(item);
    });
    
    // Add event listeners for delete buttons (existing logic)
    if (user) {
        document.querySelectorAll('.delete-type-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const typeId = e.currentTarget.dataset.typeId;
                const typeName = e.currentTarget.dataset.typeName;
                handleDeleteType(typeId, typeName);
            });
        });
        
        // --- NEW: Add event listener for the public toggles ---
        document.querySelectorAll('.public-toggle-btn').forEach(checkbox => {
            checkbox.addEventListener('change', handlePublicToggle);
        });
        // ----------------------------------------------------
    }
}
        /**
         * Fetches document types from the database and updates UI elements.
         */
        async function fetchAndRenderDocuments() {
    loadingMessage.classList.remove('hidden');

    // 1. Determine which document types should be shown
    const publicTypeNames = documentTypes
        .filter(type => type.is_public === true)
        .map(type => type.name);

    let query = supabase.from(TABLE_NAME).select('*'); 

    // 2. Apply filtering logic only if the user is NOT logged in (Public View)
    if (!user) {
        if (publicTypeNames.length > 0) {
            // Filter documents to include only public types
            query = query.in('type', publicTypeNames);
        } else {
             // If no types are marked public, prevent any documents from being fetched
             loadingMessage.classList.add('hidden');
             documentCategoriesContainer.innerHTML = '<p class="text-center text-gray-500 p-8">No documents are currently authorized for public view.</p>';
             return;
        }
    }
    // Note: Admins see ALL documents, regardless of the is_public setting.

    const { data: documents, error } = await query;

    loadingMessage.classList.add('hidden');

    if (error) {
       // ... existing error handling ...
       // (keep your existing RLS error block)
       return;
    }

    // --- Apply Search (Keep existing search logic) ---
    let filteredDocuments = documents;
    const searchTerm = searchInput.value.trim().toLowerCase();
    if (searchTerm) {
        filteredDocuments = documents.filter(doc =>
            (doc.docNumber && doc.docNumber.toLowerCase().includes(searchTerm)) ||
            (doc.title && doc.title.toLowerCase().includes(searchTerm))
        );
    }
    // --------------------------------------------------

    renderDocuments(filteredDocuments); 
}

        /**
         * Handles submission of the new document type form. (CREATE)
         */
        async function handleNewTypeSubmit(event) {
            event.preventDefault();
            if (!user) return showNotification('You must be logged in to add a new type.', 'error');

            const newTypeName = newTypeNameInput.value.trim();
            if (!newTypeName) return showNotification('Type name cannot be empty.', 'error');

            addTypeButton.disabled = true;
            addTypeButton.textContent = 'Adding...';

            try {
                const { error } = await supabase
                    .from(TYPES_TABLE_NAME)
                    .insert([{ name: newTypeName }]);

                if (error) {
                    if (error.code === '23505') { 
                        showNotification(`Error: The type "${newTypeName}" already exists.`, 'error');
                    } else {
                        throw error;
                    }
                } else {
                    showNotification(`New type "${newTypeName}" added successfully!`);
                    newTypeForm.reset();
                }
            } catch (error) {
                console.error("Error adding new type:", error);
                showNotification(`Error: Could not add type. ${error.message}`, 'error');
            } finally {
                addTypeButton.disabled = false;
                addTypeButton.textContent = 'Add Type';
            }
        }

        async function handlePublicToggle(event) {
    if (!user) return showNotification('Error: Must be logged in to modify types.', 'error');
    
    const typeId = event.currentTarget.dataset.typeId;
    const isPublic = event.currentTarget.checked;
    
    // Disable all toggles while saving to prevent rapid updates
    document.querySelectorAll('.public-toggle-btn').forEach(btn => btn.disabled = true);

    const { error } = await supabase
        .from(TYPES_TABLE_NAME)
        .update({ is_public: isPublic })
        .eq('id', typeId);

    // Re-enable all toggles
    document.querySelectorAll('.public-toggle-btn').forEach(btn => btn.disabled = false);

    if (error) {
        console.error("Error updating public status:", error);
        showNotification(`Error updating type public status: ${error.message}`, 'error');
        // Revert UI on error
        event.currentTarget.checked = !isPublic; 
    } else {
        showNotification(`Type public status set to ${isPublic ? 'Visible' : 'Hidden'} for public view.`, 'success');
        // The realtime listener will trigger fetchAndRenderDocumentTypes, which will refresh all UI elements.
    }
}
        /**
         * Handles deletion of a document type. (DELETE)
         * @param {string} typeId - The ID of the document type to delete.
         * @param {string} typeName - The name of the document type.
         */
        async function handleDeleteType(typeId, typeName) {
            if (!user) return showNotification('You must be logged in to delete a type.', 'error');

            const { count, error: countError } = await supabase
                .from(TABLE_NAME)
                .select('id', { count: 'exact', head: true })
                .eq('type', typeName);
            
            if (countError) {
                console.error('Count error:', countError);
            }

            if (count > 0) {
                 showNotification(`Cannot delete "${typeName}". ${count} documents are currently using this type.`, 'error');
                 return;
            }
            
            const confirmed = await showConfirmationModal(
                `Delete Type: ${typeName}`,
                `Are you sure you want to permanently delete the document type "${typeName}"?`,
                'Yes, Delete Type'
            );

            if (!confirmed) {
                return;
            }

            try {
                const { error } = await supabase
                    .from(TYPES_TABLE_NAME)
                    .delete()
                    .eq('id', typeId);

                if (error) throw error;
                
                showNotification(`Type "${typeName}" deleted successfully!`);
                await fetchAndRenderDocumentTypes(); 

            } catch (error) {
                console.error("Error deleting type:", error);
                showNotification(`Error: Could not delete type. ${error.message}`, 'error');
            }
        }
        
        // --- DOCUMENT FUNCTIONS (READ/LINK/DELETE/EDIT) ---

        /**
         * Handles the search action.
         */
        function handleSearchAndFilter(event) {
            event.preventDefault(); 
            // Documents are fetched regardless of login status
            fetchAndRenderDocuments();
        }

        /**
         * Shows the modal to link a file and populates it with document data.
         */
        function handleLinkFile(docId, docNumber, currentUrl) {
             if (!user) return showNotification('You must be logged in as an admin to link a file.', 'error');
             
             linkDocIdInput.value = docId;
             linkDocNumberSpan.textContent = docNumber;
             fileLinkInput.value = currentUrl || ''; // Pre-fill if a link already exists
             
             linkModal.classList.remove('hidden');
        }

        /**
         * Handles the form submission for updating the document's file link. (Admin only)
         */
        async function handleUpdateFileLink(event) {
            event.preventDefault();
            if (!user) return showNotification('You must be logged in to update a file link.', 'error');

            const docId = linkDocIdInput.value;
            const newFileUrl = fileLinkInput.value.trim();
            const docNumber = linkDocNumberSpan.textContent;

            const confirmBtn = document.getElementById('link-confirm-btn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Saving...';

            try {
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .update({ fileUrl: newFileUrl }) 
                    .eq('id', docId);

                if (error) throw error;
                
                showNotification(`File link for Document #${docNumber} saved successfully!`);
                linkModal.classList.add('hidden');
                linkFileForm.reset(); 
                
            } catch (error) {
                console.error("Error updating file link:", error);
                showNotification(`Error: Could not save file link. ${error.message}`, 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Save Link';
            }
        }

        /**
         * Handles the deletion of a document. (Admin only)
         */
        async function handleDeleteDocument(docId, docNumber) {
            if (!user) return showNotification('You must be logged in to delete a document.', 'error');

            const confirmed = await showConfirmationModal(
                `Delete Document #${docNumber}`,
                `Are you sure you want to permanently delete document #${docNumber}? This cannot be undone.`,
                'Yes, Delete It'
            );

            if (!confirmed) {
                return;
            }

            try {
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', docId);

                if (error) throw error;
                
                showNotification(`Document #${docNumber} deleted successfully!`);
                
            } catch (error) {
                console.error("Error deleting document:", error);
                showNotification(`Error: Could not delete document. ${error.message}`, 'error');
            }
        }

        /**
         * Handles click on Edit Document button. (Admin only)
         */
        async function handleEditDocument(id, docNumber, title, date, type) {
            if (!user) {
                showNotification('You must be logged in to edit a document.', 'error');
                return;
            }

            // Store the ID (so we know it’s an update later)
            docIdInput.value = id || '';

            // Prefill visible fields
            docNumberInput.value = docNumber || '';
            docTitleInput.value = title || '';

            // Fix date if it includes time (e.g., 2025-10-06T00:00:00Z → 2025-10-06)
            if (date) {
                const formattedDate = date.split('T')[0];
                docDateInput.value = formattedDate;
            } else {
                docDateInput.value = '';
            }

            // Ensure the type exists in the dropdown before setting
            if (type && !Array.from(docTypeSelect.options).some(opt => opt.value === type)) {
                const newOption = document.createElement('option');
                newOption.value = type;
                newOption.textContent = type;
                docTypeSelect.appendChild(newOption);
            }
            docTypeSelect.value = type || '';

            // Switch form to edit mode
            formTitle.textContent = `Edit Document #${docNumber}`;
            submitButton.textContent = 'Update Document';
            cancelEditButton.classList.remove('hidden');

            // Show form, hide list
            formViewContainer.classList.remove('hidden');
            listViewContainer.classList.add('hidden'); // CRITICAL: Hide the list view
            typeManagementContainer.classList.add('hidden'); // CRITICAL: Hide type management
        }


        /**
         * Renders the list of documents grouped by type into the UI.
         */
        function renderDocuments(documents) {
            documentCategoriesContainer.innerHTML = ''; 

    if (!documents || documents.length === 0) {
        documentCategoriesContainer.innerHTML = '<p class="text-center text-gray-500 p-8">No documents found matching the current criteria.</p>';
        return;
    }

    // Group documents by type
    const groupedDocs = documents.reduce((acc, doc) => {
        // Use doc.type or fall back to 'Uncategorized Documents'
        const type = doc.type || 'Uncategorized Documents'; 
        if (!acc[type]) {
            acc[type] = [];
        }
        acc[type].push(doc);
        return acc;
    }, {});

    // Get all unique categories from the documents and sort them alphabetically
    let categoriesToDisplay = Object.keys(groupedDocs).sort();
    
    // If 'Uncategorized Documents' exists, move it to the end
    const uncategorizedIndex = categoriesToDisplay.indexOf('Uncategorized Documents');
    if (uncategorizedIndex > -1) {
        categoriesToDisplay.splice(uncategorizedIndex, 1);
        categoriesToDisplay.push('Uncategorized Documents');
    }


    // Render each category section
    categoriesToDisplay.forEach(category => {
        let docs = groupedDocs[category];
        
        // --- CORE CHANGE: SORT WITHIN CATEGORY ---
        // 1. Sort by Document Number using natural sort
        // 2. Secondary sort by Date (newest first, descending) for documents with the same number
        docs.sort((a, b) => {
            const numSort = naturalSort(a.docNumber, b.docNumber);
            if (numSort !== 0) {
                return numSort;
            }

            // Secondary sort by Date
            return new Date(b.date).getTime() - new Date(a.date).getTime();
        });
        // ------------------------------------------

        const categorySection = document.createElement('div');
        categorySection.className = 'mb-6';
        
        const headerColor = category.includes('Executive') ? 'border-red-500 text-red-700' :
                            category.includes('Memorandum') ? 'border-blue-500 text-blue-700' :
                            category.includes('Urgent') ? 'border-yellow-500 text-yellow-700' :
                            'border-gray-500 text-gray-700';

        let categoryHtml = `<h3 class="text-xl font-semibold mb-4 pb-2 border-b-2 ${headerColor}">${category} (${docs.length})</h3>`;
        
        // Document Cards for this category
        const docCards = docs.map(doc => {
            const colorClass = getTypeColor(doc.type); 
            
            // Format the date for display
            const displayDate = new Date(doc.date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            // View File button (Always visible if link exists)
            const viewFileButton = doc.fileUrl ? 
                `<a href="${doc.fileUrl}" target="_blank" rel="noopener noreferrer"
                    class="bg-indigo-600 text-white p-2 rounded-lg font-medium text-sm hover:bg-indigo-700 transition">
                    View File
                </a>` : 
                `<button disabled 
                    class="bg-gray-400 text-white p-2 rounded-lg font-medium text-sm cursor-not-allowed">
                    View File
                </button>`;

            // Admin Buttons (Conditional rendering based on login status)
            const adminButtons = user ? `
    <button data-doc-id="${doc.id}" 
            data-doc-number="${doc.docNumber}" 
            data-title="${(doc.title || '').replace(/"/g, '&quot;')}" 
            data-date="${doc.date}" 
            data-type="${(doc.type || '').replace(/"/g, '&quot;')}"
            class="edit-doc-btn bg-yellow-500 text-white p-2 rounded-lg font-medium text-sm hover:bg-yellow-600 transition">
        Edit
    </button>
    <button data-doc-id="${doc.id}" data-doc-number="${doc.docNumber}" data-current-url="${doc.fileUrl || ''}"
            class="link-file-btn bg-green-500 text-white p-2 rounded-lg font-medium text-sm hover:bg-green-600 transition">
        Link File
    </button>
    <button data-doc-id="${doc.id}" data-doc-number="${doc.docNumber}"
            class="delete-doc-btn bg-red-500 text-white p-2 rounded-lg font-medium text-sm hover:bg-red-600 transition">
        Delete
    </button>
` : '';


            return `
                <div class="bg-white p-4 rounded-lg border border-gray-100 mb-3 hover:shadow-md transition duration-200 flex justify-between items-center flex-wrap gap-2">
                    <div class="flex-grow min-w-[200px]">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="px-2 py-0.5 text-xs font-semibold rounded-full ring-1 ring-inset ${colorClass} inline-block">
                                ${doc.type || 'Uncategorized'}
                            </span>
                            <span class="text-xs text-gray-500">${displayDate}</span>
                        </div>
                        <p class="text-sm font-medium text-gray-500 mt-1">
                            # <span class="font-bold text-gray-700">${doc.docNumber}</span>
                        </p>
                        <p class="text-lg font-bold text-gray-900 mt-1">${doc.title}</p>
                    </div>
                    <div class="flex space-x-2">
                        ${viewFileButton}
                        ${adminButtons}
                    </div>
                </div>
            `;
        }).join('');

        categorySection.innerHTML = categoryHtml + docCards;
        documentCategoriesContainer.appendChild(categorySection);
    });

    if (documentCategoriesContainer.innerHTML === '') {
        documentCategoriesContainer.innerHTML = '<p class="text-center text-gray-500 p-8">No documents found matching the current criteria.</p>';
    }

    // Only attach event listeners for admin functionality if admin is logged in
    if (user) {
        document.querySelectorAll('.link-file-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const docId = parseInt(e.currentTarget.dataset.docId);
                const docNumber = e.currentTarget.dataset.docNumber;
                const currentUrl = e.currentTarget.dataset.currentUrl;
                handleLinkFile(docId, docNumber, currentUrl);
            });
        });
        document.querySelectorAll('.delete-doc-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const docId = parseInt(e.currentTarget.dataset.docId);
                const docNumber = e.currentTarget.dataset.docNumber;
                handleDeleteDocument(docId, docNumber);
            });
        });
        // --- FIX: ATTACH EDIT LISTENER HERE AFTER ELEMENTS ARE RENDERED ---
        document.querySelectorAll('.edit-doc-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const el = e.currentTarget;
                // Read all the info we placed in the data-* attributes
                const id = el.dataset.docId || el.getAttribute('data-doc-id');
                const number = el.dataset.docNumber || el.getAttribute('data-doc-number');
                const title = el.dataset.title || el.getAttribute('data-title');
                const date = el.dataset.date || el.getAttribute('data-date');
                const type = el.dataset.type || el.getAttribute('data-type');

                handleEditDocument(id, number, title, date, type);
            });
        });
        // ------------------------------------------------------------------
    }
}
      // --- REMOVED THE OLD, DISSOCIATED EDIT BUTTON LISTENER HERE ---
        /**
         * Handles the form submission to save (INSERT) a new document. (Admin only)
         */
        async function handleFormSubmit(event) {
    event.preventDefault();

    if (!user)
        return showNotification('You must be logged in to record or update a document.', 'error');

    const id = docIdInput.value.trim(); // 👈 this hidden field decides Add vs Edit
    const docNumber = docNumberInput.value.trim();
    const docTitle = docTitleInput.value.trim();
    const docDate = docDateInput.value;
    const docType = docTypeSelect.value;

    if (!docNumber || !docTitle || !docDate || !docType) {
        showNotification('Please fill in all fields.', 'error');
        return;
    }

    const documentData = {
        docNumber,
        title: docTitle,
        date: docDate,
        type: docType,
        fileUrl: null, // keep your existing field
    };

    submitButton.disabled = true;
    submitButton.textContent = id ? 'Updating...' : 'Saving...';

    try {
        let error;

        if (id) {
            // ✏️ UPDATE existing record
            ({ error } = await supabase
                .from(TABLE_NAME)
                .update(documentData)
                .eq('id', id));
        } else {
            // ➕ INSERT new record
            ({ error } = await supabase
                .from(TABLE_NAME)
                .insert([documentData]));
        }

        if (error) throw error;

        // ✅ Success message differs depending on mode
        showNotification(
            id
                ? 'Document updated successfully!'
                : 'Document recorded successfully! You can now link a file on the dashboard.'
        );

        resetDocumentForm(); // reset fields & hide edit mode
        toggleFormVisibility(false); // return to list view
        // The realtime listener should handle the refresh, but keeping this for robustness
        // fetchAndRenderDocuments(); 

    } catch (error) {
        console.error('Error submitting document:', error);
        showNotification(`Error: Could not save document. ${error.message}`, 'error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Record Document';
    }
}

        // --- Event Listeners ---
        form.addEventListener('submit', handleFormSubmit);
        viewToggleButton.addEventListener('click', () => toggleFormVisibility());
        // Updated cancel logic to explicitly show list view
        cancelEditButton.addEventListener('click', () => { 
            resetDocumentForm();
            toggleFormVisibility(false);
        }); 
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);
        newTypeForm.addEventListener('submit', handleNewTypeSubmit); 
        searchForm.addEventListener('submit', handleSearchAndFilter);
        
        refreshButton.addEventListener('click', () => {
            fetchAndRenderDocuments();
            showNotification('Document list refreshed.', 'success');
        });

        // Link Modal Listeners
        linkFileForm.addEventListener('submit', handleUpdateFileLink);
        linkCancelBtn.addEventListener('click', () => {
            linkModal.classList.add('hidden');
            linkFileForm.reset();
        });

        // Initialize the application when the script loads
        initializeSupabase();

    </script>

</body>
</html>
